# 障碍物功能说明

## 修改内容

已成功在连续导航测试环境中添加障碍物功能，**不影响训练环境**。

### 1. 修改的文件

#### `gym_pybullet_drones/custom/space_expander.py`
- 在 `ExtendedHoverAviary.__init__()` 中添加 `obstacles` 参数
- 重写 `_addObstacles()` 方法，添加5个不同形状、颜色和高度的障碍物

#### `gym_pybullet_drones/custom/continuous_navigator.py`
- 在创建环境时传入 `obstacles=True` 参数

### 2. 障碍物布置方案

根据当前环境大小 **X[-1.5, 1.5], Y[-1.5, 1.5], Z[0.05, 2.5]** 米，共添加5个障碍物：

| 编号 | 形状 | 颜色 | 位置 (x, y, z) | 尺寸描述 |
|------|------|------|----------------|----------|
| 1 | 立方体柱 | 红色 | (0.8, 0.8, 0.4) | 较高窄柱 0.3×0.3×0.8m |
| 2 | 圆柱体 | 蓝色 | (-0.9, -0.6, 0.4) | 中等圆柱 半径0.12m 高0.8m |
| 3 | 立方体 | 绿色 | (0.6, -0.8, 0.25) | 矮胖方块 0.4×0.4×0.5m |
| 4 | 细圆柱 | 黄色 | (-0.7, 0.5, 0.6) | 高细柱 半径0.08m 高1.2m |
| 5 | 球体 | 紫色 | (-1.0, 0.0, 0.68) | 悬浮球 半径0.18m |

### 3. 设计考虑

✅ **避开中心区域** - 中心 (0, 0) 附近保持畅通，用于无人机起降  
✅ **分布在边缘** - 障碍物主要放置在边缘和角落，测试导航能力  
✅ **多样化形状** - 包含立方体、圆柱、球体，增加挑战性  
✅ **不同高度** - 从0.25米到1.2米高度不等，测试3D避障  
✅ **半透明显示** - 设置透明度为0.8，便于观察无人机  

## 使用方法

### 启动带障碍物的连续导航

```bash
# 激活环境
conda activate drones

# 运行连续导航（障碍物已自动启用）
cd /home/peking/projects/RL/gym-pybullet-drones
python gym_pybullet_drones/custom/rollout_continuous.py

# 或使用其他参数
python gym_pybullet_drones/custom/rollout_continuous.py --gui --record
```

### 测试建议

1. **起飞测试** - 确认无人机能在中心 (0, 0, 0.1) 正常起飞
2. **目标导航** - 尝试设置目标点，观察无人机如何避障
3. **推荐测试点**：
   - `0.5 0.5 1.0` - 接近红色柱子
   - `-0.5 0.3 1.0` - 接近黄色柱子
   - `0.8 -0.5 1.0` - 接近绿色方块
   - `-0.8 -0.3 1.0` - 接近蓝色圆柱
   - `-1.0 0.2 1.0` - 接近紫色球体

### 预期效果

在PyBullet GUI中，您应该能看到：
- 地面平面（灰色）
- 无人机（小型四旋翼）
- 5个不同颜色的障碍物分布在环境中
- 无人机会尝试导航到目标点（模型未专门训练避障，可能会碰撞）

## 注意事项

⚠️ **重要提示**：
- 当前使用的模型**没有在障碍物环境中训练**
- 无人机可能**不会主动避障**，可能会发生碰撞
- 这是正常现象，因为模型在训练时环境中没有障碍物
- 如需真正的避障能力，需要重新训练模型

### 如果需要训练具有避障能力的模型

需要修改训练脚本，在训练环境中也启用障碍物：

```python
# 在训练脚本中（不在本次修改范围内）
train_env = make_vec_env(
    HoverAviary,  # 使用训练环境
    env_kwargs=dict(
        gui=False,
        record=False,
        obstacles=True,  # 在训练时也启用障碍物
        ...
    ),
    ...
)
```

## 禁用障碍物

如需临时禁用障碍物，修改 `continuous_navigator.py` 第135行：

```python
# 将 obstacles=True 改为 obstacles=False
self.env = ExtendedHoverAviary(
    ...
    obstacles=False  # 禁用障碍物
)
```

## 调整障碍物

如需修改障碍物的位置、数量或属性，编辑：
`gym_pybullet_drones/custom/space_expander.py` 中的 `_addObstacles()` 方法

---

**修改完成时间**: 2025年10月24日  
**修改范围**: 仅连续导航测试环境，不影响训练环境
