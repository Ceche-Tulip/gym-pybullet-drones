# AGF调试指南 - 详细输出说明

## 📊 新增的调试输出

### 1. 导航开始信息
```
======================================================================
🚁 开始APF避障导航 - 详细调试模式
======================================================================
起点: [-1.000, -1.000, 0.500]
终点: [1.000, 1.000, 0.500]
直线距离: 2.828m
APF步长: 0.15m
APF更新频率: 每3步
目标判定距离: 0.35m
======================================================================
```

### 2. APF规划详情（每30步显示）
```
======================================================================
[步数   30] 🔍 详细调试信息
======================================================================
当前位置:     [ -0.850,  -0.850,   0.500]
最终目标:     [  1.000,   1.000,   0.500]
中间航点:     [ -0.744,  -0.744,   0.500]
----------------------------------------------------------------------
航点相对位置: [  0.106,   0.106,   0.000]
航点距离:     0.1500m ✓
目标相对位置: [  1.850,   1.850,   0.000]
目标距离:     2.6162m
航点更新:     ✅ 成功
----------------------------------------------------------------------
APF引力:      2.6162
APF斥力:      0.0000
APF步长:      0.1500m
======================================================================
```

**关键指标**:
- **航点距离**: 应该 < 0.15m（APF步长）
- **⚠️ 如果航点距离 > 0.7m**: PPO可能无法正确响应
- **目标相对位置**: 显示从当前位置到最终目标的向量
- **航点更新成功/失败**: 如果失败说明航点超出环境范围

### 3. PPO执行详情（每50步显示）
```
[PPO步数   50] 观测目标距离: 0.1400m, 动作强度: 0.523, 动作: [0.67, 0.52, -0.09, -0.69]
[PPO步数  100] 观测目标距离: 0.1500m, 动作强度: 0.531, 动作: [0.68, 0.53, -0.08, -0.70]
[PPO步数  150] 观测目标距离: 0.6800m, 动作强度: 0.682, 动作: [0.89, 0.85, 0.04, -0.98]
                 ⚠️ 警告: 观测目标距离 0.6800m > 0.8m (可能超出PPO训练范围)
```

**关键指标**:
- **观测目标距离**: PPO看到的中间航点距离
- **⚠️ 如果 > 0.8m**: 超出PPO训练范围，动作可能不准确
- **动作强度**: 平均动作幅度（0-1），接近1说明模型全力输出
- **动作值接近±1.0**: 说明模型饱和，可能泛化能力不足

### 4. 打转检测（每100步显示）
```
[打转检测] 最近100步移动: 0.2500m, 到目标: 1.5000m, 状态: ✓ 正常移动
[打转检测] 最近100步移动: 0.1200m, 到目标: 1.2000m, 状态: ✓ 正常移动
[打转检测] 最近100步移动: 0.0450m, 到目标: 0.8000m, 状态: ⚠️ 可能卡住
[打转检测] 最近100步移动: 0.0300m, 到目标: 0.4500m, 状态: ⚠️ 可能卡住
```

**关键指标**:
- **最近100步移动**: < 0.5m 说明可能卡住
- **到目标距离**: 与最终目标的直线距离
- **状态判定**: 
  - `正常移动`: 100步移动 >= 0.5m
  - `可能卡住`: 100步移动 < 0.5m

### 5. 打转判定触发
```
======================================================================
🎯 检测到接近目标且移动停滞
======================================================================
   最近100步移动距离: 0.035m
   当前到目标距离: 0.450m
   当前位置: [0.700, 0.700, 0.500]
   目标位置: [1.000, 1.000, 0.500]
   ✅ 判定为成功到达！
======================================================================
```

## 🔍 问题诊断流程

### 诊断点1: 检查航点距离
**位置**: APF规划详情中的"航点距离"

**正常**: 0.10-0.15m（等于step_size）
**异常**: > 0.20m 或 持续 > 0.15m

**可能原因**:
- APF步长设置过大
- APF引力/斥力计算错误

**解决方案**:
```python
# agf_navigator.py 第129行
step_size=0.10,  # 进一步减小
```

### 诊断点2: 检查观测目标距离
**位置**: PPO执行详情中的"观测目标距离"

**正常**: < 0.7m
**警告**: 0.7-0.9m
**危险**: > 0.9m（会触发警告）

**可能原因**:
- APF生成的航点距离当前位置太远
- step_size 相对于 apf_update_freq 过大

**解决方案**:
```python
# 方案1: 减小步长
step_size=0.10

# 方案2: 增加更新频率
apf_update_freq=2  # 从3减到2
```

### 诊断点3: 检查动作饱和
**位置**: PPO执行详情中的"动作"和"动作强度"

**正常**: 动作值 -0.8 到 0.8，动作强度 0.3-0.7
**警告**: 多个动作值接近 ±1.0，动作强度 > 0.8
**危险**: 持续动作值 = ±1.0，动作强度 > 0.9

**说明**: PPO模型输出饱和，说明目标超出训练范围

### 诊断点4: 检查卡住位置
**位置**: 打转检测中的"当前位置"

**分析**: 如果无人机持续卡在某个位置（如 0.7, 0.7），查看：
1. 该位置的"观测目标距离"是否 > 0.8m
2. 该位置的"航点距离"是否过大
3. 该位置的"动作"是否饱和

## 📊 测试命令

### 运行详细调试测试
```bash
cd gym_pybullet_drones/AGF

# 方式1: 直接运行
conda run -n drones python test_agf_navigation.py --start -1 -1 0.5 --target 1 1 0.5

# 方式2: 使用调试脚本（保存日志）
./run_debug_test.sh
```

### 查看日志
```bash
# 查看完整日志
cat debug_output.log

# 查找关键信息
grep "⚠️" debug_output.log          # 查找所有警告
grep "航点距离" debug_output.log     # 查找航点距离
grep "观测目标距离" debug_output.log # 查找PPO观测
grep "打转检测" debug_output.log     # 查找打转状态
```

## 🎯 预期结果分析

### 场景A: 成功到达
```
- 航点距离始终 < 0.15m ✓
- 观测目标距离 < 0.7m ✓
- 动作强度 0.3-0.7 ✓
- 最终触发打转检测或APF判定到达 ✓
```

### 场景B: 卡在中途（如0.7附近）
```
- 某个位置后，观测目标距离开始 > 0.8m ❌
- 动作值出现 ±1.0 饱和 ❌
- 打转检测显示"可能卡住" ❌
- 100步移动距离 < 0.1m ❌
```

**证实**: PPO模型泛化能力不足

**解决**: 
1. 立即：减小step_size到0.10m
2. 短期：增加apf_update_freq到2
3. 长期：重新训练PPO模型

## 📝 调试检查清单

在运行测试后，检查以下项目：

- [ ] 航点距离是否始终 < 0.15m？
- [ ] 观测目标距离何时开始 > 0.8m？
- [ ] 动作值是否出现饱和（±1.0）？
- [ ] 无人机卡在哪个位置？（记录坐标）
- [ ] 卡住时到最终目标的距离是多少？
- [ ] 打转检测是否正确触发？
- [ ] 100步移动距离最小是多少？

## 🚀 下一步

根据调试输出结果：

1. **如果航点距离 > 0.15m**: 检查APF代码
2. **如果观测距离 > 0.8m**: 减小step_size
3. **如果动作饱和**: 确认是PPO限制
4. **如果卡在特定位置**: 分析该位置的所有指标

---

**文件**: `DEBUG_GUIDE.md`
**更新**: 2025-10-24
**用途**: AGF系统详细调试指南
